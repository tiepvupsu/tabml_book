
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Factorization machine &#8212; Machine Learning cho dữ liệu dạng bảng</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.5f77b4aec8189eecf79907ce328c390d.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/my.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"TeX": {"Macros": {"N": "\\mathbb{N}", "floor": ["\\lfloor#1\\rfloor", 1], "bmat": ["\\left[\\begin{array}"], "emat": ["\\end{array}\\right]"]}}, "tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <link rel="canonical" href="https://machinelearningcoban.com/tabml_book/ch_recommendation_system/factorization_machine.html" />
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Dữ liệu chuỗi thời gian" href="../ch_data_processing/timeseries_data.html" />
    <link rel="prev" title="Matrix Factorization" href="matrix_factorization.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Machine Learning cho dữ liệu dạng bảng</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Lời nói đầu
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Giới thiệu
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../ch_intro/properties.html">
   Đặc điểm của dữ liệu dạng bảng
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ch_intro/pipeline.html">
   Machine Learning pipeline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ch_intro/why_pipeline.html">
   Tại sao cần xây dựng pipeline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ch_intro/tabml.html">
   Thư viện tabml đi kèm cuốn sách
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ch_intro/titanic_pipeline.html">
   Pipeline đơn giản cho cuộc thi Titanic
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ch_intro/main_contents.html">
   Bố cục cuốn sách
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ch_intro/contributions.html">
   Đóng góp vào dự án
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ch_intro/datasets.html">
   Các bộ dữ liệu sử dụng trong sách
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Kỹ thuật xử lý dữ liệu
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../ch_data_processing/eda.html">
   Phân tích Khám phá Dữ liệu - EDA
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../ch_data_processing/eda_purpose.html">
     Mục đích của EDA
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ch_data_processing/eda_titanic.html">
     EDA cho dữ liệu Titanic
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ch_data_processing/eda_cali_housing.html">
     EDA cho dữ liệu California Housing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ch_data_processing/pandas-profiling.html">
     Pandas profiling
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../ch_data_processing/data_cleaning.html">
   Làm sạch dữ liệu
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../ch_data_processing/process_outliers.html">
     Xử lý các giá trị ngoại lệ
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ch_data_processing/process_missing.html">
     Xử lý dữ liệu bị khuyết
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../ch_data_processing/categorical_data.html">
   Đặc trưng hạng mục (WIP)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../ch_data_processing/onehot.html">
     Mã hóa one-hot
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ch_data_processing/hashing.html">
     Hashing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../ch_data_processing/crossing.html">
     Crossing
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ch_data_processing/numeric_data.html">
   Đặc trưng dạng số (WIP)
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Embedding
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../ch_embedding/embedding.html">
   Embedding
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ch_embedding/word2vec.html">
   Word2vec
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ch_embedding/product2vec.html">
   Instacart Product2vec
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Hệ thống gợi ý
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="introduction.html">
   Hệ thống gợi ý
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ml_1m.html">
   Bộ dữ liệu MovieLens-1M
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="content_based.html">
   Hệ thống dựa trên nội dung
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="matrix_factorization.html">
   Matrix Factorization
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Factorization machine
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Đóng góp từ tác giả khác
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../ch_data_processing/timeseries_data.html">
   Dữ liệu chuỗi thời gian
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ch_model/decision_tree.html">
   Decision Tree algorithm
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ch_model/random_forest.html">
   Random Forest algorithm
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Phụ lục
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../ap/visualization.html">
   Minh họa dữ liệu
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="../_sources/ch_recommendation_system/factorization_machine.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/ch_recommendation_system/factorization_machine.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/tiepvupsu/tabml_book"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/tiepvupsu/tabml_book/issues/new?title=Issue%20on%20page%20%2Fch_recommendation_system/factorization_machine.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/tiepvupsu/tabml_book/edit/main/book/ch_recommendation_system/factorization_machine.md"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/tiepvupsu/tabml_book/main?urlpath=tree/book/ch_recommendation_system/factorization_machine.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#gioi-thieu">
   Giới thiệu
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#huan-luyen-mo-hinh">
   Huấn luyện mô hình
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#vi-du-voi-movielens-1m">
   Ví dụ với MovieLens-1M
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tai-va-phan-chia-du-lieu">
     Tải và phân chia dữ liệu
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#chuan-bi-tap-du-lieu-cho-pytorch">
     Chuẩn bị tập dữ liệu cho Pytorch
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#xay-dung-thong-tin-nguoi-dung">
       Xây dựng thông tin người dùng
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#xay-dung-thong-tin-phim">
       Xây dựng thông tin phim
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#xay-dung-factorizationmachinedataset">
       Xây dựng
       <code class="docutils literal notranslate">
        <span class="pre">
         FactorizationMachineDataset
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dinh-nghia-mo-hinh">
     Định nghĩa mô hình
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#huan-luyen-va-danh-gia-mo-hinh">
     Huấn luyện và đánh giá mô hình
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#minh-hoa-ket-qua">
   Minh hoạ kết quả
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tom-tat-va-thao-luan">
   Tóm tắt và thảo luận
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="factorization-machine">
<span id="sec-fm"></span><h1>Factorization machine<a class="headerlink" href="#factorization-machine" title="Permalink to this headline">¶</a></h1>
<div class="section" id="gioi-thieu">
<h2>Giới thiệu<a class="headerlink" href="#gioi-thieu" title="Permalink to this headline">¶</a></h2>
<p>Nhắc lại nhược điểm lớn nhất của mô hình <a class="reference internal" href="matrix_factorization.html#sec-mf"><span class="std std-ref">matrix factorization</span></a> (MF) là nó không có khả năng mô hình hóa những thông tin bổ trợ về người dùng và sản phẩm. Một phương pháp mở rộng dựa trên MF là <a class="reference external" href="https://www.csie.ntu.edu.tw/~b97053/paper/Rendle2010FM.pdf">factorization machines</a> (FM) với khả năng mô hình hóa được những thông tin bên lề và mang lại sự cải thiện đáng kể. Phương pháp này cũng là nền móng có nhiều phương pháp liên quan đển Deep Learning cho bài toán gợi ý về sau. Trong mục này, chúng ta sẽ dẫn giải ý tưởng và triển khai mô hình cho bài toán gợi ý với bộ dữ liệu MovieLens-1M.</p>
<p>Trong MF, coi dữ liệu đầu vào là cặp (người dùng, sản phẩm) được biểu diễn bằng một vector <span class="math notranslate nohighlight">\(\mathbf{x} \in \mathbb{R}^{1\times d}\)</span> chỉ có hai phần tử bằng một tương ứng với chỉ số của người dùng <span class="math notranslate nohighlight">\(i\)</span> và sản phẩm <span class="math notranslate nohighlight">\(j\)</span> đó như được biểu diễn ở như <a class="reference internal" href="#img-fm1"><span class="std std-numref">Fig. 16</span></a> (ở đây sản phẩm là bộ phim).</p>
<div class="figure align-default" id="img-fm1">
<img alt="../_images/fm1.png" src="../_images/fm1.png" />
<p class="caption"><span class="caption-number">Fig. 16 </span><span class="caption-text">Diễn giải lại mô hình Matrix Factorization.</span><a class="headerlink" href="#img-fm1" title="Permalink to this image">¶</a></p>
</div>
<p>Hai ma trận embeddings của người dùng và sản phẩm cũng được ghép lại với nhau thành một ma trận <span class="math notranslate nohighlight">\(\mathbf{V} \in \mathbb{R}^{k\times d}\)</span>. Đồng thời, ta cũng ghép toàn bộ các hệ số tự do của người dùng và sản phẩm thành một vector <span class="math notranslate nohighlight">\(\mathbf{w} \in \mathbb{R}^{d \times 1}\)</span> (không hiển thị trong hình). Khi đó, độ quan tâm của người dùng <span class="math notranslate nohighlight">\(i\)</span> tới sản phẩm <span class="math notranslate nohighlight">\(j\)</span> được viết lại thành:</p>
<div class="math notranslate nohighlight" id="equation-eq-fm-1">
<span class="eqno">(4)<a class="headerlink" href="#equation-eq-fm-1" title="Permalink to this equation">¶</a></span>\[
\hat{y}_{ij} = \mathbf{v}_i^T\mathbf{v}_j + w_i + w_j + w_0
\]</div>
<p>với <span class="math notranslate nohighlight">\(w_i\)</span> là hệ số thiên hướng ứng với người dùng <span class="math notranslate nohighlight">\(i\)</span> thể hiện độ “khó tính” của người dùng; <span class="math notranslate nohighlight">\(w_j\)</span> là hệ số thiên hướng ứng với độ yêu thích của sản phẩm <span class="math notranslate nohighlight">\(j\)</span>; và hệ số <span class="math notranslate nohighlight">\(w_0\)</span> thể hiện thiên hướng chung của các đánh giá trong bộ dữ liệu.</p>
<p>Vì <span class="math notranslate nohighlight">\(x_i = x_j = 1\)</span> (ứng với các chỉ số của người dùng và sản phẩm) và các thành phần còn lại của <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> bằng 0, ta có thể viết lại:</p>
<div class="math notranslate nohighlight" id="equation-eq-fm-2">
<span class="eqno">(5)<a class="headerlink" href="#equation-eq-fm-2" title="Permalink to this equation">¶</a></span>\[
\hat{y}_{ij} = w_0 + \mathbf{x}\mathbf{w} + \mathbf{v}_i^T\mathbf{v}_jx_i x_j
\]</div>
<p>Hai số hạng đầu tiên của vế phải trong <a class="reference internal" href="#equation-eq-fm-2">(5)</a> giống với hồi quy tuyến tính, số hạng cuối cùng thể hiện sự tương tác giữa thành phần thứ <span class="math notranslate nohighlight">\(i\)</span> (người dùng) với thành phần thứ <span class="math notranslate nohighlight">\(j\)</span> (sản phẩm). Ta cần tìm các giá trị <span class="math notranslate nohighlight">\(w_0, \mathbf{w}, \mathbf{V}\)</span> từ dữ liệu.</p>
<p>Với bộ dữ liệu MovieLens-1M, ta còn có những thông tin liên quan về người dùng như giới tính, tuổi và nghề nghiệp. Với phim, ta cũng có thông tin về thể loại. Nếu tiếp tục chèn thêm vào <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> các thành phần liên quan đến giới tính, tuổi, nghề nghiệp và thể loại phim. Những thành phần này là các one-hot vector hoặc multi-hot vector (với thể loại phim) ứng với các dữ liệu dạng hạng mục và đều là những vector nhị phân có rất ít thành phần khác không. Nếu có thêm các dữ liệu dạng số khác, ta cũng có thể thêm vào <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> các phần tử tương ứng. Với dữ liệu dạng số, mỗi đặc trưng tương ứng với một thành phần trong <span class="math notranslate nohighlight">\(mathbf{x}\)</span> và có thể là giá trị thực thay vì nhị phân. Với mỗi thành phần thêm vào <span class="math notranslate nohighlight">\(\mathbf{x}\)</span>, ta thêm một cột vector embeding vào <span class="math notranslate nohighlight">\(\mathbf{V}\)</span> như trong <a class="reference internal" href="#img-fm2"><span class="std std-numref">Fig. 17</span></a>.</p>
<div class="figure align-default" id="img-fm2">
<img alt="../_images/fm2.png" src="../_images/fm2.png" />
<p class="caption"><span class="caption-number">Fig. 17 </span><span class="caption-text">Factorization Machine cho dữ liệu MovieLens-1M.</span><a class="headerlink" href="#img-fm2" title="Permalink to this image">¶</a></p>
</div>
<p>Lúc này, ngoài việc mô hình hóa sự tương tác giữa người dùng và bộ phim, ca cũng có thể mô hình hóa tương tác giữa người dùng và mỗi thể loại phim, hoặc nhóm tuổi với mỗi bộ phim, nhóm tuổi với thể loại phim. Sự tương tác giữa người dùng và nhóm tuổi hay nhóm tuổi với nghề nghiệp cũng được mô hình hóa. Tổng quát hơn, ta không cần quan tâm tới ý nghĩa của từng thành phần trong <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> mà có thể sử dụng tất cả các cặp hai thành phần khác nhau trong <span class="math notranslate nohighlight">\(\mathbf{x}\)</span>.</p>
<p>Khi đó, độ quan tâm của một người dùng tới một bộ phim có thể được xây dựng như sau:</p>
<div class="math notranslate nohighlight" id="equation-eq-fm-3">
<span class="eqno">(6)<a class="headerlink" href="#equation-eq-fm-3" title="Permalink to this equation">¶</a></span>\[
\hat{y} = w_0 + \mathbf{x}\mathbf{w} + \sum_{i = 1}^{d}\sum_{j=i+1}^d \mathbf{v}_i^T\mathbf{v}_j x_i x_j
\]</div>
<p>Đây chính là ý tưởng chính của FM. Biểu thức trên đây rất đẹp như sẽ được chứng minh ở dưới, đồng thời nhờ vào việc <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> thường là một vector rất thưa (rất ít thành phần khác 0), việc huấn luyện và dự đoán trở nên rất nhanh ngay cả khi số lượng người dùng và sản phẩm lớn.</p>
<p>Biểu thức trên đây thể hiện mối quan hệ bậc hai giữa các thành phần của <span class="math notranslate nohighlight">\(\mathbf{x}\)</span>. FM có thể được mở rộng ra các bậc cao hơn, tuy nhiên các thí nghiệm thực tế cho thấy các bậc cao không mang lại kết quả tốt hơn nhiều trong khi lượng phép toán tăng lên đáng kể.</p>
<p>Cần phải nhấn mạnh thêm rằng, chỉ cần áp dụng các hàm mất mát phù hợp vào <span class="math notranslate nohighlight">\(\hat{y}\)</span> trong <a class="reference internal" href="#equation-eq-fm-3">(6)</a> ta có thể áp dụng FM vào cả bài toán phân loại hoặc hồi quy.</p>
</div>
<div class="section" id="huan-luyen-mo-hinh">
<h2>Huấn luyện mô hình<a class="headerlink" href="#huan-luyen-mo-hinh" title="Permalink to this headline">¶</a></h2>
<p>Tương tự như MF, việc huấn luyện các thành phần <span class="math notranslate nohighlight">\(w_0, \mathbf{w}\)</span> và <span class="math notranslate nohighlight">\(\mathbf{V}\)</span> cũng được thực hiện thông qua Gradient Descent. Việc tính toán với hai số hạng đầu tiên trong <a class="reference internal" href="#equation-eq-fm-3">(6)</a> tương đối hiển nhiên, số hạng cuối cần khéo léo một chút:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
2\sum_{i = 1}^{d}\sum_{j=i+1}^d \mathbf{v}_i^T\mathbf{v}_j x_i x_j  
&amp; = \Big(\sum_{i=1}^d \sum_{j=1}^d \mathbf{v}_i^T \mathbf{v}_j x_i x_j - \sum_{i=1}^d \mathbf{v}_i^T \mathbf{v}_i x_i x_i \Big) \\
&amp; = \frac{1}{2}\Big(\sum_{i=1}^d \sum_{j=1}^d \sum_{l=1}^k v_{i, l}v_{j, l} x_i x_j - \sum_{i=1}^d \sum_{l=1}^k v_{i, l} v_{i, l} x_i x_i \Big) \\
&amp; = \frac{1}{2}\sum_{l=1}^k \Big(\sum_{i=1}^d v_{i, l}x_i \sum_{j=1}^d v_{j, l} x_j - \sum_{i=1}^d \big(v_{i, l} x_i\big)^2 \Big) \\
&amp; = \sum_{l=1}^k \Big(\big(\sum_{i=1}^d v_{i, l}x_i\big)^2 - \sum_{i=1}^d \big(v_{i, l} x_i\big)^2 \Big) \\
&amp; = \sum_{l=1}^k \big(\sum_{i=1}^d v_{i, l}x_i\big)^2 - \sum_{l=1}^k \sum_{i=1}^d \big(v_{i, l} x_i\big)^2 \\
\end{align}
\end{split}\]</div>
<p>với <span class="math notranslate nohighlight">\(v_{i, l}\)</span> là thành phần ở cột thứ <span class="math notranslate nohighlight">\(i\)</span> và hàng thứ <span class="math notranslate nohighlight">\(l\)</span> của <span class="math notranslate nohighlight">\(\mathbf{V}\)</span>.</p>
<p>Cả hai thành phần trên đây đều có thể được tính nhanh chóng dựa vào các phép toán nhân ma trận <span class="math notranslate nohighlight">\(\mathbf{V}\)</span> và vector <span class="math notranslate nohighlight">\(\mathbf{x}\)</span>. Phép toán này đặc biệt hiệu quả trong bài toán hệ thống gợi ý với <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> có các thành phần chủ yếu bằng 0.</p>
</div>
<div class="section" id="vi-du-voi-movielens-1m">
<h2>Ví dụ với MovieLens-1M<a class="headerlink" href="#vi-du-voi-movielens-1m" title="Permalink to this headline">¶</a></h2>
<div class="section" id="tai-va-phan-chia-du-lieu">
<h3>Tải và phân chia dữ liệu<a class="headerlink" href="#tai-va-phan-chia-du-lieu" title="Permalink to this headline">¶</a></h3>
<p>Tương tự như trong MF, trước tiên ta tải và phân chia dữ liệu thành tập huấn luyện và tập kiểm thử.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># build dataset</span>
<span class="kn">import</span> <span class="nn">pytorch_lightning</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.multiprocessing</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">Dataset</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">tabml.datasets</span>


<span class="n">GLOBAL_SEED</span> <span class="o">=</span> <span class="mi">42</span>  <span class="c1"># number of life</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">GLOBAL_SEED</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">GLOBAL_SEED</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">set_sharing_strategy</span><span class="p">(</span><span class="s1">&#39;file_system&#39;</span><span class="p">)</span>

<span class="n">df_dict</span> <span class="o">=</span> <span class="n">tabml</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">download_movielen_1m</span><span class="p">()</span>
<span class="n">users</span><span class="p">,</span> <span class="n">movies</span><span class="p">,</span> <span class="n">ratings</span> <span class="o">=</span> <span class="n">df_dict</span><span class="p">[</span><span class="s2">&quot;users&quot;</span><span class="p">],</span> <span class="n">df_dict</span><span class="p">[</span><span class="s2">&quot;movies&quot;</span><span class="p">],</span> <span class="n">df_dict</span><span class="p">[</span><span class="s2">&quot;ratings&quot;</span><span class="p">]</span>
<span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;Rating&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s2">&quot;Rating&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3</span>  <span class="c1"># rating range (-2, 2)</span>
<span class="n">train_ratings</span><span class="p">,</span> <span class="n">validation_ratings</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">ratings</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="chuan-bi-tap-du-lieu-cho-pytorch">
<h3>Chuẩn bị tập dữ liệu cho Pytorch<a class="headerlink" href="#chuan-bi-tap-du-lieu-cho-pytorch" title="Permalink to this headline">¶</a></h3>
<p>Ta sẽ sử dụng các thông tin sau cho người dùng và bộ phim:</p>
<ul class="simple">
<li><p>Với người dùng: chỉ số của 6040 người dùng, 2 giới tính, 7 nhóm tuổi và 21 nghề nghiệp. Tổng là 6070.</p></li>
<li><p>Với bộ phim: chỉ số của 3883 bộ phim và 18 thể loại. Tổng là 3901.</p></li>
</ul>
<p>Số chiều tương ứng với người dùng và bộ phim là khá lớn. Tuy nhiên ta không lưu toàn bộ vector này mà chỉ cần lưu mảng chứa vị trí của các phần tử bằng 1 ứng với các hạng mục tương ứng trong mỗi nhóm. Về sau, <code class="docutils literal notranslate"><span class="pre">nn.Embedding</span></code> sẽ giúp ta lấy ra các embedding tương ứng một cách nhanh chóng.</p>
<div class="section" id="xay-dung-thong-tin-nguoi-dung">
<h4>Xây dựng thông tin người dùng<a class="headerlink" href="#xay-dung-thong-tin-nguoi-dung" title="Permalink to this headline">¶</a></h4>
<p>Với mỗi người dùng, mã của họ được lưu ở <code class="docutils literal notranslate"><span class="pre">UserID</span></code>. Giới tính là <code class="docutils literal notranslate"><span class="pre">M</span></code> (Nam) hoặc <code class="docutils literal notranslate"><span class="pre">F</span></code> (Nữ). Tuổi được lưu dưới dạng tuổi thấp nhất trong các nhóm [1, 18), [18, 25), [25, 35), [35, 45), [45, 50), [50, 55), và 56 trở lên. Nghề nghiệp đã được lưu sẵn dưới dạng chỉ số từ 0 đến 20.</p>
<p>Mỗi người dùng sẽ được lưu bởi một mảng 4 giá trị [chỉ số người dùng, chỉ số giới tính, chỉ số nhóm tuổi, chỉ số nghề nghiệp]. Chỉ số người dùng là 1 trong 6040 giá trị đầu tiên từ 0 đến 6039, chỉ số giới tính là một trong hai giá trị 6040 (Nam) hoặc 6041 (Nữ) và tương tự với chỉ số nhóm tuổi và chỉ số nghề nghiệp.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># user_featuers</span>
<span class="n">user_index_by_id</span> <span class="o">=</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="s2">&quot;UserID&quot;</span><span class="p">])</span> <span class="p">}</span>
<span class="n">gender_index_by_name</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;M&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="n">age_index_by_name</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">18</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">25</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">35</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">45</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">50</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">56</span><span class="p">:</span><span class="mi">6</span><span class="p">}</span>
<span class="n">occupations</span> <span class="o">=</span> <span class="p">[</span>
<span class="s2">&quot;other&quot;</span><span class="p">,</span>
<span class="s2">&quot;academic/educator&quot;</span><span class="p">,</span>
<span class="s2">&quot;artist&quot;</span><span class="p">,</span>
<span class="s2">&quot;clerical/admin&quot;</span><span class="p">,</span>
<span class="s2">&quot;college/grad student&quot;</span><span class="p">,</span>
<span class="s2">&quot;customer service&quot;</span><span class="p">,</span>
<span class="s2">&quot;doctor/health care&quot;</span><span class="p">,</span>
<span class="s2">&quot;executive/managerial&quot;</span><span class="p">,</span>
<span class="s2">&quot;farmer&quot;</span><span class="p">,</span>
<span class="s2">&quot;homemaker&quot;</span><span class="p">,</span>
<span class="s2">&quot;K-12 student&quot;</span><span class="p">,</span>
<span class="s2">&quot;lawyer&quot;</span><span class="p">,</span>
<span class="s2">&quot;programmer&quot;</span><span class="p">,</span>
<span class="s2">&quot;retired&quot;</span><span class="p">,</span>
<span class="s2">&quot;sales/marketing&quot;</span><span class="p">,</span>
<span class="s2">&quot;scientist&quot;</span><span class="p">,</span>
<span class="s2">&quot;self-employed&quot;</span><span class="p">,</span>
<span class="s2">&quot;technician/engineer&quot;</span><span class="p">,</span>
<span class="s2">&quot;tradesman/craftsman&quot;</span><span class="p">,</span>
<span class="s2">&quot;unemployed&quot;</span><span class="p">,</span>
<span class="s2">&quot;writer&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">occupation_index_by_name</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">occupations</span><span class="p">)}</span>

<span class="n">num_users</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
<span class="n">gender_offset</span> <span class="o">=</span> <span class="n">num_users</span>
<span class="n">age_offset</span> <span class="o">=</span> <span class="n">gender_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">gender_index_by_name</span><span class="p">)</span>
<span class="n">occupation_offset</span> <span class="o">=</span> <span class="n">age_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">age_index_by_name</span><span class="p">)</span>

<span class="n">user_features</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_users</span><span class="p">):</span>
    <span class="n">gender_index</span> <span class="o">=</span> <span class="n">gender_index_by_name</span><span class="p">[</span><span class="n">users</span><span class="p">[</span><span class="s2">&quot;Gender&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]]</span> <span class="o">+</span> <span class="n">gender_offset</span>
    <span class="n">age_index</span> <span class="o">=</span> <span class="n">age_index_by_name</span><span class="p">[</span><span class="n">users</span><span class="p">[</span><span class="s2">&quot;Age&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]]</span> <span class="o">+</span> <span class="n">age_offset</span>
    <span class="n">occupation_index</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="s2">&quot;Occupation&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">occupation_offset</span>
    <span class="n">user_features</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">index</span><span class="p">,</span> <span class="n">gender_index</span><span class="p">,</span> <span class="n">age_index</span><span class="p">,</span> <span class="n">occupation_index</span><span class="p">])</span>
    
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Example for the first user: &quot;</span><span class="p">,</span> <span class="n">user_features</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="xay-dung-thong-tin-phim">
<h4>Xây dựng thông tin phim<a class="headerlink" href="#xay-dung-thong-tin-phim" title="Permalink to this headline">¶</a></h4>
<p>Tương tự như vậy, mỗi bộ phim sẽ được lưu bởi một mảng mà giá trị đầu tiên là chỉ số của bộ phim, các giá trị tiếp theo là chỉ số của các thể loại. Lưu ý rằng các bộ phim có thể có số lượng thể loại khác nhau.</p>
<p>Vì sau này ta sẽ đặt thông tin bộ phim về phía sau thông tin người dùng, chỉ số của bộ phim sẽ bắt đầu từ 6070 (là kích thước vector người dùng).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># build moive_features</span>

<span class="n">movie_index_by_id</span> <span class="o">=</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">movies</span><span class="p">[</span><span class="s2">&quot;MovieID&quot;</span><span class="p">])}</span>
<span class="n">movie_offset</span> <span class="o">=</span> <span class="n">occupation_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">occupation_index_by_name</span><span class="p">)</span>

<span class="n">genres</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Action&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Adventure&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Animation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Children&#39;s&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Comedy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Crime&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Documentary&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Drama&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Fantasy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Film-Noir&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Horror&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Musical&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mystery&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Romance&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Sci-Fi&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Thriller&quot;</span><span class="p">,</span>
    <span class="s2">&quot;War&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Western&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">genre_index_by_name</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">genres</span><span class="p">)}</span>
<span class="n">num_movies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">movies</span><span class="p">)</span>

<span class="n">movie_features</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">movie_genres</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">movies</span><span class="p">[</span><span class="s2">&quot;Genres&quot;</span><span class="p">]):</span>
    <span class="n">movie_feature</span> <span class="o">=</span> <span class="p">[</span><span class="n">movie_offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">movie_genres</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">):</span>
        <span class="n">genre_index</span> <span class="o">=</span> <span class="n">genre_index_by_name</span><span class="p">[</span><span class="n">genre</span><span class="p">]</span> <span class="o">+</span> <span class="n">num_movies</span> <span class="o">+</span> <span class="n">movie_offset</span>
        <span class="n">movie_feature</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">genre_index</span><span class="p">)</span>
    <span class="n">movie_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">movie_feature</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Example for the first movie:&quot;</span><span class="p">,</span> <span class="n">movie_features</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">total_inputs</span> <span class="o">=</span> <span class="n">movie_offset</span> <span class="o">+</span> <span class="n">num_movies</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">genres</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">total_inputs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="xay-dung-factorizationmachinedataset">
<h4>Xây dựng <code class="docutils literal notranslate"><span class="pre">FactorizationMachineDataset</span></code><a class="headerlink" href="#xay-dung-factorizationmachinedataset" title="Permalink to this headline">¶</a></h4>
<p>Không giống như trong MF ở đó mỗi điểm dữ liệu được lưu dưới dạng <code class="docutils literal notranslate"><span class="pre">(user_id,</span> <span class="pre">movie_id,</span> <span class="pre">rating)</span></code>, với FM ta sẽ lưu một mảng chứa các chỉ số của các phần tử bằng một trong vector đặc trưng của người dùng và phim. Vì các mảng này có kích thước khác nhau, để có thể huấn luyện theo batch, ta cần <em>pad</em> thêm một lượng chỉ số phụ ở cuối sao cho các mảng có kích thước bằng nhau. Khi cập nhật trọng số, các thành phần tương ứng với chỉ số pad này sẽ không được cập nhật. (Đọc thêm về <code class="docutils literal notranslate"><span class="pre">padding_idx</span></code> trong <a class="reference external" href="https://pytorch.org/docs/stable/generated/torch.nn.Embedding.html">torch.nn.Embdding</a>)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>

<span class="n">NUM_MOVIES</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">movies</span><span class="p">)</span>
<span class="n">NUM_USERS</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
<span class="n">padding_idx</span> <span class="o">=</span> <span class="n">total_inputs</span>


<span class="k">class</span> <span class="nc">FactorizationMachineDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rating_df</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rating_df</span> <span class="o">=</span> <span class="n">rating_df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_size</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">genres</span><span class="p">)</span>  <span class="c1"># 4 for user feature + movie index + genres</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rating_df</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">user_index</span> <span class="o">=</span> <span class="n">user_index_by_id</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rating_df</span><span class="p">[</span><span class="s2">&quot;UserID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>
        <span class="n">movie_index</span> <span class="o">=</span> <span class="n">movie_index_by_id</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rating_df</span><span class="p">[</span><span class="s2">&quot;MovieID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>
        <span class="n">rating</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rating_df</span><span class="p">[</span><span class="s2">&quot;Rating&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">user_feature</span> <span class="o">=</span> <span class="n">user_features</span><span class="p">[</span><span class="n">user_index</span><span class="p">]</span>
        <span class="n">movie_feature</span> <span class="o">=</span> <span class="n">movie_features</span><span class="p">[</span><span class="n">movie_index</span><span class="p">]</span>
        <span class="n">padding_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_feature</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">movie_feature</span><span class="p">)</span>
        <span class="n">feature</span> <span class="o">=</span> <span class="n">user_feature</span> <span class="o">+</span> <span class="n">movie_feature</span> <span class="o">+</span> <span class="p">[</span><span class="n">padding_idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">padding_size</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">IntTensor</span><span class="p">(</span><span class="n">feature</span><span class="p">),</span> <span class="n">rating</span>


<span class="n">training_data</span> <span class="o">=</span> <span class="n">FactorizationMachineDataset</span><span class="p">(</span><span class="n">train_ratings</span><span class="p">)</span>
<span class="n">validation_data</span> <span class="o">=</span> <span class="n">FactorizationMachineDataset</span><span class="p">(</span><span class="n">validation_ratings</span><span class="p">)</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">num_workers</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>

<span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">training_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span>
<span class="p">)</span>

<span class="n">validation_dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">validation_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="dinh-nghia-mo-hinh">
<h3>Định nghĩa mô hình<a class="headerlink" href="#dinh-nghia-mo-hinh" title="Permalink to this headline">¶</a></h3>
<p>Đoạn code dưới đây định nghĩa mô hình FM, ở đó các thuộc tính <code class="docutils literal notranslate"><span class="pre">bias,</span> <span class="pre">linear_layer,</span> <span class="pre">embedding</span></code> lần lượt là <span class="math notranslate nohighlight">\(w_0, \mathbf{w}\)</span> và <span class="math notranslate nohighlight">\(\mathbf{V}\)</span> trong biểu thức <a class="reference internal" href="#equation-eq-fm-3">(6)</a>. Đầu ra của mô hình được cắt về khoảng (-2, 2) tương ứng với khoảng giá trị đánh giá (1 đến 5 sau khi chuẩn hóa bằng cách trừ 3).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pytorch_lightning.loggers</span> <span class="kn">import</span> <span class="n">TensorBoardLogger</span>
<span class="kn">import</span> <span class="nn">jdc</span>

<span class="n">LR</span> <span class="o">=</span> <span class="mf">5e-4</span>
<span class="n">WEIGHT_DECAY</span> <span class="o">=</span> <span class="mf">5e-5</span>


<span class="k">class</span> <span class="nc">FactorizationMachine</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_inputs</span><span class="p">,</span> <span class="n">num_factors</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FactorizationMachine</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_inputs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_factors</span><span class="p">,</span> <span class="n">padding_idx</span><span class="o">=</span><span class="n">padding_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">uniform_</span><span class="p">(</span><span class="o">-</span><span class="mf">.1</span><span class="p">,</span> <span class="mf">.1</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_inputs</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">padding_idx</span><span class="o">=</span><span class="n">padding_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">pow_of_sum</span> <span class="o">=</span> <span class="n">emb</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sum_of_pow</span> <span class="o">=</span> <span class="n">emb</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">out_inter</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">pow_of_sum</span> <span class="o">-</span> <span class="n">sum_of_pow</span><span class="p">)</span>
        <span class="n">out_lin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out_inter</span> <span class="o">+</span> <span class="n">out_lin</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="nb">min</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">add_to</span> <span class="n">FactorizationMachine</span>
<span class="k">def</span> <span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
    <span class="n">inputs</span><span class="p">,</span> <span class="n">rating</span> <span class="o">=</span> <span class="n">batch</span>
    <span class="n">rating</span> <span class="o">=</span> <span class="n">rating</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">rating</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;batch_loss&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
    <span class="n">inputs</span><span class="p">,</span> <span class="n">rating</span> <span class="o">=</span> <span class="n">batch</span>
    <span class="n">rating</span> <span class="o">=</span> <span class="n">rating</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">rating</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;batch_loss&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">training_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">add_scalars</span><span class="p">(</span>
        <span class="s2">&quot;RMSE&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Train&quot;</span><span class="p">:</span> <span class="n">avg_loss</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">},</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span>
    <span class="p">)</span>
    <span class="n">epoch_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">avg_loss</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">validation_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">add_scalars</span><span class="p">(</span>
        <span class="s2">&quot;RMSE&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Val&quot;</span><span class="p">:</span> <span class="n">avg_loss</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">},</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span>
    <span class="p">)</span>
    <span class="n">epoch_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">avg_loss</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">LR</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">WEIGHT_DECAY</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">optimizer</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="huan-luyen-va-danh-gia-mo-hinh">
<h3>Huấn luyện và đánh giá mô hình<a class="headerlink" href="#huan-luyen-va-danh-gia-mo-hinh" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_factors</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">TensorBoardLogger</span><span class="p">(</span>
    <span class="s2">&quot;fm_2_tb_logs&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ilr</span><span class="si">{</span><span class="n">LR</span><span class="si">}</span><span class="s2">_wd</span><span class="si">{</span><span class="n">WEIGHT_DECAY</span><span class="si">}</span><span class="s2">_emb</span><span class="si">{</span><span class="n">n_factors</span><span class="si">}</span><span class="s2">_b</span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">FactorizationMachine</span><span class="p">(</span><span class="n">num_inputs</span><span class="o">=</span><span class="n">total_inputs</span><span class="p">,</span> <span class="n">num_factors</span><span class="o">=</span><span class="n">n_factors</span><span class="p">)</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span><span class="n">gpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>

<span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_dataloader</span><span class="p">,</span> <span class="n">validation_dataloader</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">eval_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_dataloader</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">rating</span> <span class="ow">in</span> <span class="n">train_dataloader</span><span class="p">:</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">+=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">rating</span><span class="p">)</span>
    <span class="n">RMSE</span> <span class="o">=</span> <span class="p">(</span><span class="n">loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">))</span><span class="o">**</span><span class="mf">.5</span>
    <span class="k">return</span> <span class="n">RMSE</span>
    
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train RMSE: </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eval_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_dataloader</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Validation RMSE: </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eval_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">validation_dataloader</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>Kết quả thu được đã tốt hơn so với MF.</p>
</div>
</div>
<div class="section" id="minh-hoa-ket-qua">
<h2>Minh hoạ kết quả<a class="headerlink" href="#minh-hoa-ket-qua" title="Permalink to this headline">¶</a></h2>
<p>Từ ma trận embedding thu được, chúng ta sẽ minh họa các bộ phim chỉ thuộc một thể loại trong số <code class="docutils literal notranslate"><span class="pre">Drama,</span> <span class="pre">Comedy</span></code> và <code class="docutils literal notranslate"><span class="pre">Horror</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># find movies with single genres</span>
<span class="n">embs_arr</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()[</span><span class="s1">&#39;embedding.weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">movie_genres</span> <span class="o">=</span> <span class="n">movies</span><span class="p">[</span><span class="s2">&quot;Genres&quot;</span><span class="p">]</span>
<span class="n">movie_inds_one_genre</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">gs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">movie_genres</span><span class="p">)</span> <span class="k">if</span> <span class="n">gs</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Drama&#39;</span><span class="p">,</span> <span class="s1">&#39;Comedy&#39;</span><span class="p">,</span> <span class="s1">&#39;Horror&#39;</span><span class="p">)]</span>

<span class="n">movie_embs</span> <span class="o">=</span> <span class="n">embs_arr</span><span class="p">[</span><span class="n">movie_offset</span><span class="p">:</span> <span class="n">movie_offset</span> <span class="o">+</span> <span class="n">num_movies</span><span class="p">,</span> <span class="p">:]</span>
<span class="n">movie_subset_embs</span> <span class="o">=</span> <span class="n">movie_embs</span><span class="p">[</span><span class="n">movie_inds_one_genre</span><span class="p">,</span> <span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<p>Embedding của những bộ phim này được minh họa trong không gian hai chiều sử dụng <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.manifold.TSNE.html">t-SNE</a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>

<span class="n">movie_subset_embs</span><span class="o">.</span><span class="n">shape</span>
<span class="n">movie_2d</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s1">&#39;pca&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">movie_subset_embs</span><span class="p">)</span>
<span class="n">movie_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">movie_2d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">movie_2d</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;genre&quot;</span><span class="p">:</span> <span class="n">movie_genres</span><span class="p">[</span><span class="n">movie_inds_one_genre</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;genre&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">movie_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Mặc dù không thực sự rõ ràng, ta vẫn có thể thấy các bộ phim cùng thể loại (cùng màu) có xu hướng tập trung vào những khu vực gần nhau. Điều này chứng tỏ FM đã học được những thông tin hữu ích từ dữ liệu.</p>
<p>Bạn đọc có thể minh hoạc các nhóm embedding khác để tìm ra những điều thú vị khác của dữ liệu.</p>
</div>
<div class="section" id="tom-tat-va-thao-luan">
<h2>Tóm tắt và thảo luận<a class="headerlink" href="#tom-tat-va-thao-luan" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Factorization Machine là một phương pháp mở rộng của Matrix Factorization ở đó thông tin về sự tương tác giữa nhiều thành phần thông tin khác nhau được mô hình hóa dưới dạng một biểu thức bạc hai hoặc cao hơn. Thông thường, chỉ các tương tác bậc hai được sử dụng để giảm độ phức tạp tính toán.</p></li>
<li><p>Ưu điểm nổi bật của nó so với MF là việc nó có thể tận dụng những thông tin bên lề về người dùng và sản phẩm để xây dựng mô hình. Ngoài ra, FM cũng giải quyết được vấn đề “khởi đầu lạnh” khi một người dùng hoặc sản phẩm chưa hề có tương tác nhưng đã có thông tin riêng về người dùng/sản phẩm đó.</p></li>
</ul>
<hr class="docutils" />
<p><em>Phần hệ thống gợi ý có thể có thêm các bài viết khác.</em></p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./ch_recommendation_system"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="matrix_factorization.html" title="previous page">Matrix Factorization</a>
    <a class='right-next' id="next-link" href="../ch_data_processing/timeseries_data.html" title="next page">Dữ liệu chuỗi thời gian</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Tiep Vu<br/>
        
            &copy; Copyright 2021.<br/>
          <div class="extra_footer">
            <div id="disqus_thread"></div>
  <script>
      /**
      *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
      *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
      /*
      var disqus_config = function () {
      this.page.url = machinelearningcoban.com;  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = tabml; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
      };
      */
      (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://tabml.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

          </div>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<script>
                        window.ga = window.ga || function () {
                            (ga.q = ga.q || []).push(arguments) };
                        ga.l = +new Date;
                        ga('create', 'UA-89509207-2', 'auto');
                        ga('set', 'anonymizeIp', true);
                        ga('send', 'pageview');
                    </script>

  </body>
</html>